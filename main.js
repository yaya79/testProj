(()=>{var e={409:(e,t,r)=>{const a=r(239),{validationResult:n}=r(553),i=r(844);e.exports=new class{async registration(e,t,r){try{const s=n(e);if(!s.isEmpty())return r(i.BadRequest("Проверьте правильность введенных данных",s.array()));const{firstName:o,lastName:c,phone:d,municipality:l,email:u,password:p}=e.body,g=await a.registration(o,c,d,l,u,p);return t.cookie("refreshToken",g.refreshToken,{maxAge:2592e6,httpOnly:!0}),t.json(g)}catch(e){r(e)}}async editFairSave(e,t,r){try{const{id:r,adress:n,contact:i,dateStart:s,dateEnd:o,location:c,organizer:d,timeEnd:l,timeStart:u,tradingPlaces:p,type:g}=e.body,y=await a.editFairSave(r,n,i,s,o,c,d,l,u,p,g);return t.json(y)}catch(e){r(e)}}async login(e,t,r){try{const{email:r,password:n,municipality:i}=e.body,s=await a.login(r,n,i);return t.cookie("refreshToken",s.refreshToken,{maxAge:2592e6,httpOnly:!0}),t.json(s)}catch(e){r(e)}}async logout(e,t,r){try{const{refreshToken:r}=e.cookies,n=await a.logout(r);return t.clearCookie("refreshToken"),t.json(n)}catch(e){r(e)}}async activate(e,t,r){try{const r=e.params.link;return await a.activate(r),t.redirect("http://45.91.8.162:3000")}catch(e){r(e)}}async refresh(e,t,r){try{const{refreshToken:r}=e.cookies,n=await a.refresh(r);return t.cookie("refreshToken",n.refreshToken,{maxAge:2592e6,httpOnly:!0}),t.json(n)}catch(e){r(e)}}async getUsers(e,t,r){try{const e=await a.getAllUsers();return t.json(e)}catch(e){r(e)}}async getFairs(e,t,r){try{const r=await a.getUserFair(e.user.municipality);return t.json(r)}catch(e){r(e)}}async getFair(e,t,r){try{const r=e.params,n=await a.getEditFair(r.id);return t.json(n)}catch(e){r(e)}}async deleteFair(e,t,r){try{const r=e.params,n=await a.deleteEditFair(r.id);return t.json(n)}catch(e){r(e)}}async getAllData(e,t,r){try{const e=await a.allData();return t.json(e)}catch(e){r(e)}}async newFormSave(e,t,r){try{const{municipality:r,adress:n,contact:i,dateStart:s,dateEnd:o,location:c,organizer:d,timeEnd:l,timeStart:u,tradingPlaces:p,type:g}=e.body,y=await a.newFairSave(r,n,i,s,o,c,d,l,u,p,g);return t.json(y)}catch(e){r(e)}}}},732:e=>{e.exports=class{email;id;municipality;isActivated;constructor(e){this.email=e.email,this.id=e._id,this.municipality=e.municipality,this.isActivated=e.isActivated}}},844:e=>{e.exports=class e extends Error{status;errors;constructor(e,t,r=[]){super(t),this.status=e,this.errors=r}static UnauthorizedError(){return new e(401,"Пользователь не авторизован")}static BadRequest(t,r=[]){return new e(400,t,r)}}},685:(e,t,r)=>{const a=r(844),n=r(328);e.exports=function(e,t,r){try{const t=e.headers.authorization;if(!t)return r(a.UnauthorizedError());const i=t.split(" ")[1];if(!i)return r(a.UnauthorizedError());const s=n.validateAccessToken(i);if(!s)return r(a.UnauthorizedError());e.user=s,r()}catch(e){return r(a.UnauthorizedError())}}},224:(e,t,r)=>{var a=r(108);const n=r(844);e.exports=function(e,t,r,i){return a.log(e),e instanceof n?r.status(e.status).json({message:e.message,errors:e.errors}):r.status(500).json({message:"Непредвиденная ошибка"})}},810:(e,t,r)=>{const{Schema:a,model:n}=r(185),i=new a({municipality:{type:String},adress:{type:String},dateStart:{type:String},dateEnd:{type:String},organizer:{type:String},contact:{type:String},type:{type:String},timeStart:{type:String},timeEnd:{type:String},location:{type:String},tradingPlaces:{type:String}});e.exports=n("Fair",i)},258:(e,t,r)=>{const{Schema:a,model:n}=r(185),i=new a({user:{type:a.Types.ObjectId,ref:"User"},refreshToken:{type:String,required:!0}});e.exports=n("Token",i)},353:(e,t,r)=>{const{Schema:a,model:n}=r(185),i=new a({firstName:{type:String,required:!0},lastName:{type:String,required:!0},phone:{type:String},municipality:{type:String},email:{type:String,unique:!0,required:!0},password:{type:String,required:!0},isActivated:{type:Boolean,default:!1},activationLink:{type:String}});e.exports=n("User",i)},570:(e,t,r)=>{const a=r(860).Router,n=r(409),i=new a,{body:s}=r(553),o=r(685);i.post("/registration",s("email").isEmail(),s("password").isLength({min:3,max:32}),n.registration),i.post("/login",n.login),i.post("/logout",n.logout),i.post("/editFairSave",o,n.editFairSave),i.post("/newForm",o,n.newFormSave),i.post("/editForm/deleteEditFair/:id",o,n.deleteFair),i.get("/activate/:link",n.activate),i.get("/refresh",n.refresh),i.get("/users",o,n.getUsers),i.get("/fairs/",o,n.getFairs),i.get("/editForm/:id",o,n.getFair),i.get("/allDataExport",n.getAllData),e.exports=i},915:(e,t,r)=>{const a=r(184);e.exports=new class{constructor(){this.transporter=a.createTransport({host:"smtp.mail.ru",port:"465",secure:!0,auth:{user:"registryfairmoscowreg@mail.ru",pass:"0hCm1YNcJA4wLmjVE7fe"}})}async sendActivationMail(e,t,r,a,n,i){await this.transporter.sendMail({from:"registryfairmoscowreg@mail.ru",to:"registryfairmoscowreg@mail.ru",subject:"Активация аккаунта в системе Реестр Ярмарок Московской области ",text:"",html:`\n                <div>\n                Имя: ${t}<br>\n                Фамилия: ${r}<br>\n                Муниципалитет (г.о.): ${i}<br>\n                Телефон: ${a}<br>\n                email: ${n}<br>\n                </div>\n                <hr>\n                    <div>\n                        <h3>Для активации перейдите по ссылке</h3>\n                        <a href="${e}">${e}</a>\n                    </div>\n                `})}}},328:(e,t,r)=>{const a=r(344),n=r(258);e.exports=new class{generateTokens(e){return{accessToken:a.sign(e,"sdffgdfgbfllbntoekt43",{expiresIn:"150m"}),refreshToken:a.sign(e,"sdfadbnbvngfllvfl,vghjfghjm",{expiresIn:"3000000m"})}}validateAccessToken(e){try{return a.verify(e,"sdffgdfgbfllbntoekt43")}catch(e){return null}}validateRefreshToken(e){try{return a.verify(e,"sdfadbnbvngfllvfl,vghjfghjm")}catch(e){return null}}async saveToken(e,t){const r=await n.findOne({user:e});return r?(r.refreshToken=t,r.save()):await n.create({user:e,refreshToken:t})}async removeToken(e){return await n.deleteOne({refreshToken:e})}async findToken(e){return await n.findOne({refreshToken:e})}}},239:(e,t,r)=>{var a=r(108);const n=r(353),i=r(810),s=r(96),o=r(828),c=r(915),d=r(328),l=r(732),u=r(844);e.exports=new class{async registration(e,t,r,a,i,p){if(await n.findOne({email:i}))throw u.BadRequest(`Пользователь с почтовым адресом ${i} уже существует`);const g=await s.hash(p,3),y=o.v4(),f=await n.create({firstName:e,lastName:t,phone:r,municipality:a,email:i,password:p,password:g,activationLink:y});await c.sendActivationMail(`http://45.91.8.162:5000/api/activate/${y}`,e,t,r,i,a);const h=new l(f),m=d.generateTokens({...h});return await d.saveToken(h.id,m.refreshToken),{...m,user:h}}async activate(e){const t=await n.findOne({activationLink:e});if(!t)throw u.BadRequest("Неккоректная ссылка активации");t.isActivated=!0,await t.save()}async login(e,t){const r=await n.findOne({email:e});if(!r)throw u.BadRequest("Пользователь с таким email не найден");if(!await s.compare(t,r.password))throw u.BadRequest("Неверный пароль");const a=new l(r),i=d.generateTokens({...a});return await d.saveToken(a.id,i.refreshToken),{...i,user:a}}async logout(e){return await d.removeToken(e)}async refresh(e){if(!e)throw u.UnauthorizedError();const t=d.validateRefreshToken(e),r=await d.findToken(e);if(!t||!r)throw u.UnauthorizedError();const a=await n.findById(t.id),i=new l(a),s=d.generateTokens({...i});return await d.saveToken(i.id,s.refreshToken),{...s,user:i}}async getAllUsers(){return await n.find()}async getUserFair(e){return await i.find({municipality:e})}async allData(){return await i.find({},{_id:0})}async getEditFair(e){return await i.findById(e)}async deleteEditFair(e){return await i.deleteOne({_id:e})}async editFairSave(e,t,r,n,s,o,c,d,l,u,p){try{await i.findOneAndUpdate({_id:e},{$set:{adress:t,contact:r,dateStart:n,dateEnd:s,location:o,organizer:c,timeEnd:d,timeStart:l,tradingPlaces:u,type:p}})}catch(e){a.log(e)}}async newFairSave(e,t,r,n,s,o,c,d,l,u,p){try{await i.create({municipality:e,adress:t,contact:r,dateStart:n,dateEnd:s,location:o,organizer:c,timeEnd:d,timeStart:l,tradingPlaces:u,type:p})}catch(e){a.log(e)}}}},108:(e,t,r)=>{var a=r(464),n=r(84);function i(){return(new Date).getTime()}var s,o=Array.prototype.slice,c={};s="undefined"!=typeof global&&global.console?global.console:"undefined"!=typeof window&&window.console?window.console:{};for(var d=[[function(){},"log"],[function(){s.log.apply(s,arguments)},"info"],[function(){s.log.apply(s,arguments)},"warn"],[function(){s.warn.apply(s,arguments)},"error"],[function(e){c[e]=i()},"time"],[function(e){var t=c[e];if(!t)throw new Error("No such label: "+e);delete c[e];var r=i()-t;s.log(e+": "+r+"ms")},"timeEnd"],[function(){var e=new Error;e.name="Trace",e.message=a.format.apply(null,arguments),s.error(e.stack)},"trace"],[function(e){s.log(a.inspect(e)+"\n")},"dir"],[function(e){if(!e){var t=o.call(arguments,1);n.ok(!1,a.format.apply(null,t))}},"assert"]],l=0;l<d.length;l++){var u=d[l],p=u[0],g=u[1];s[g]||(s[g]=p)}e.exports=s},84:e=>{"use strict";e.exports=require("assert")},96:e=>{"use strict";e.exports=require("bcrypt")},710:e=>{"use strict";e.exports=require("cookie-parser")},582:e=>{"use strict";e.exports=require("cors")},142:e=>{"use strict";e.exports=require("dotenv")},860:e=>{"use strict";e.exports=require("express")},553:e=>{"use strict";e.exports=require("express-validator")},344:e=>{"use strict";e.exports=require("jsonwebtoken")},185:e=>{"use strict";e.exports=require("mongoose")},184:e=>{"use strict";e.exports=require("nodemailer")},464:e=>{"use strict";e.exports=require("util")},828:e=>{"use strict";e.exports=require("uuid")}},t={};function r(a){var n=t[a];if(void 0!==n)return n.exports;var i=t[a]={exports:{}};return e[a](i,i.exports,r),i.exports}(()=>{var e=r(108);r(142).config();const t=r(860),a=r(582),n=r(710),i=r(185),s=r(570),o=r(224),c=t();c.use(t.json()),c.use(n()),c.use(a({credentials:!0,origin:"http://45.91.8.162:3000"})),c.use("/api",s),c.use(o),c.use(((e,t,r)=>{t.header("Access-Control-Allow-Origin","*"),r()})),(async()=>{try{await i.connect("mongodb://localhost:27017/db_main1",{useNewUrlParser:!0,useUnifiedTopology:!0}),c.listen("5000",(()=>e.log("Server started on PORT = 5000")))}catch(t){e.log(t)}})()})()})();